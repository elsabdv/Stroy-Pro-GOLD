<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stroy-Pro GOLD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --bg: #f4f7fe; --primary: #3b82f6; --danger: #ef4444; --success: #22c55e; --dark: #1e293b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--dark); height: 100vh; overflow: hidden; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .sidebar { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; display: flex; border-top: 2px solid #e2e8f0; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        .nav-btn { flex: 1; background: none; border: none; color: #94a3b8; font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 600; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn span { font-size: 26px; margin-bottom: 3px; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .main { height: calc(100vh - 75px); overflow-y: auto; padding: 15px; }
        .page { display: none; animation: fadeIn 0.3s ease; } 
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { background: white; padding: 18px; border-radius: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #eef2f6; position: relative; }
        .dark-card { background: var(--dark); color: white; border: none; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { border: none; border-radius: 15px; padding: 15px; font-weight: 700; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-outline { background: #f8fafc; border: 1px solid #cbd5e1; color: var(--dark); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        input, select { width: 100%; padding: 15px; margin: 8px 0; border: 1.5px solid #e2e8f0; border-radius: 14px; font-size: 16px; background: #fff; outline: none; }
        input:focus { border-color: var(--primary); }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 25px; border-radius: 30px 30px 0 0; z-index: 5000; max-height: 90vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.3); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 4000; backdrop-filter: blur(6px); }
        
        .badge { font-size: 10px; padding: 4px 10px; border-radius: 10px; color: white; font-weight: 800; text-transform: uppercase; }
        .history-row { font-size: 13px; padding: 12px 0; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        
        /* –°–ø–µ—Ü –±–ª–æ–∫–∏ */
        .stat-label { color: #94a3b8; font-size: 12px; font-weight: 600; }
        .stat-val { font-size: 22px; font-weight: 800; }
    </style>
</head>
<body>

    <div class="sidebar">
        <button class="nav-btn active" onclick="switchPage('finances', this)"><span>üí≥</span>–ö–∞—Å—Å–∞</button>
        <button class="nav-btn" onclick="switchPage('stock', this)"><span>üì¶</span>–°–∫–ª–∞–¥</button>
        <button class="nav-btn" onclick="switchPage('clients', this)"><span>üë•</span>–ö–ª–∏–µ–Ω—Ç—ã</button>
    </div>

    <div class="main">
        <div id="p-finances" class="page active">
            <h2 style="margin: 5px 0 20px 0;">üí∞ –ú–æ–π –ë–∏–∑–Ω–µ—Å</h2>
            <div class="card dark-card">
                <div class="grid">
                    <div><span class="stat-label">–ù–∞–ª–∏—á–Ω—ã–µ</span><div id="f-cash" class="stat-val" style="color:#4ade80;">0</div></div>
                    <div><span class="stat-label">–ù–∞ –∫–∞—Ä—Ç–µ</span><div id="f-card" class="stat-val" style="color:#60a5fa;">0</div></div>
                </div>
                <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; border-top:1px solid #334155; padding-top:15px;">
                    <div><span class="stat-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</span><div id="f-profit" style="color:#fbbf24; font-weight:bold;">0</div></div>
                    <div><span class="stat-label">–¢–æ–≤–∞—Ä –≤ —Å–∫–ª–∞–¥–µ</span><div id="f-stock-sum" style="color:#f8fafc; font-weight:bold;">0</div></div>
                </div>
                <div class="grid" style="margin-top:20px;">
                    <button class="btn btn-blue" onclick="showMod('m-transfer')">‚áÑ –ü–µ—Ä–µ–≤–æ–¥</button>
                    <button class="btn btn-blue" onclick="askPin('m-adjust')">‚öôÔ∏è –ü—Ä–∞–≤–∫–∞</button>
                </div>
            </div>

            <div class="grid" style="margin-bottom:20px;">
                <button class="btn btn-outline" onclick="exportData()">üíæ –ë—ç–∫–∞–ø</button>
                <button class="btn btn-outline" onclick="document.getElementById('fileIn').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <input type="file" id="fileIn" style="display:none" onchange="importData(this)">
            </div>

            <h4 style="color:var(--danger)">üî¥ –î–æ–ª–≥–∏ –Ω–∞–º (–ö–ª–∏–µ–Ω—Ç—ã): <span id="sum-c-debt" style="float:right">0</span></h4>
            <div id="list-c-debts" class="card" style="padding:0; max-height:150px; overflow-y:auto;"></div>

            <h4 style="color:var(--primary)">üöõ –ù–∞—à–∏ –¥–æ–ª–≥–∏ (–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏): <span id="sum-v-debt" style="float:right">0</span></h4>
            <div id="list-v-debts" class="card" style="padding:0; max-height:150px; overflow-y:auto;"></div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px;">
                <h4>üìä –ñ—É—Ä–Ω–∞–ª –∫–∞—Å—Å—ã</h4>
                <div style="display:flex; gap:10px;">
                    <button onclick="doExport('fin', 'xlsx')" style="color:green; border:0; background:none; font-weight:bold;">XLS</button>
                    <button onclick="doExport('fin', 'pdf')" style="color:red; border:0; background:none; font-weight:bold;">PDF</button>
                </div>
            </div>
            <div id="fin-history" class="card" style="padding:0; max-height:300px; overflow-y:auto;"></div>
            <button class="btn btn-red" style="font-size:10px; padding:10px;" onclick="clearHistory('logs')">–£–î–ê–õ–ò–¢–¨ –ò–°–¢–û–†–ò–Æ –ö–ê–°–°–´</button>
        </div>

        <div id="p-stock" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">üì¶ –°–∫–ª–∞–¥</h2>
                <button class="btn btn-blue" style="width:auto; padding:10px 20px;" onclick="showMod('m-add-stock')">+ –ó–∞–∫—É–ø</button>
            </div>
            <div id="stock-list"></div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px;">
                <h4>üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—É–ø–∞</h4>
                <div style="display:flex; gap:10px;">
                    <button onclick="doExport('stock', 'xlsx')" style="color:green; border:0; background:none; font-weight:bold;">XLS</button>
                    <button onclick="doExport('stock', 'pdf')" style="color:red; border:0; background:none; font-weight:bold;">PDF</button>
                </div>
            </div>
            <div id="stock-history" class="card" style="padding:0; max-height:300px; overflow-y:auto;"></div>
            <button class="btn btn-red" style="font-size:10px; padding:10px;" onclick="clearHistory('stockLogs')">–£–î–ê–õ–ò–¢–¨ –ò–°–¢–û–†–ò–Æ –°–ö–õ–ê–î–ê</button>
        </div>

        <div id="p-clients" class="page">
            <h2 style="margin:0 0 15px 0;">üë• –ö–ª–∏–µ–Ω—Ç—ã</h2>
            <button class="btn btn-blue" style="margin-bottom:20px;" onclick="showMod('m-add-client')">+ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
            <div id="clients-list"></div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="hideMods()"></div>
    <div id="print-area"></div>

    <div id="m-pin" class="modal">
        <h3>üîê –í–≤–µ–¥–∏—Ç–µ –ü–ò–ù</h3>
        <input type="number" id="pin-val" placeholder="****" style="text-align:center; font-size:24px; letter-spacing:10px;">
        <button class="btn btn-blue" onclick="checkPin()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="m-add-stock" class="modal">
        <h3>üì¶ –ù–æ–≤–æ–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>
        <input type="text" id="st-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <div class="grid">
            <input type="number" id="st-buy" placeholder="–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∞">
            <input type="number" id="st-sell" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏">
        </div>
        <input type="number" id="st-qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
        <input type="text" id="st-vendor" placeholder="–ü–æ—Å—Ç–∞–≤—â–∏–∫">
        <select id="st-pay-method">
            <option value="cash">–û–ø–ª–∞—Ç–∏—Ç—å –ù–∞–ª–∏—á–Ω—ã–º–∏</option>
            <option value="card">–û–ø–ª–∞—Ç–∏—Ç—å –ö–∞—Ä—Ç–æ–π</option>
            <option value="debt">–í–∑—è—Ç—å –≤ –î–û–õ–ì</option>
        </select>
        <button class="btn btn-blue" onclick="logicAddStock()">–ü—Ä–∏–Ω—è—Ç—å —Ç–æ–≤–∞—Ä</button>
    </div>

    <div id="m-stock-item" class="modal">
        <h3 id="m-st-title">–¢–æ–≤–∞—Ä</h3>
        <div id="m-st-info"></div>
        <input type="number" id="m-st-return-qty" placeholder="–°–∫–æ–ª—å–∫–æ –≤–µ—Ä–Ω—É—Ç—å?">
        <button class="btn btn-red" onclick="logicReturnStock()">–û—Ñ–æ—Ä–º–∏—Ç—å –í–û–ó–í–†–ê–¢</button>
    </div>

    <div id="m-transfer" class="modal">
        <h3>‚áÑ –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
        <select id="tr-from"><option value="cash">–° –ù–∞–ª–∏—á–Ω—ã—Ö</option><option value="card">–° –ö–∞—Ä—Ç—ã</option></select>
        <select id="tr-to"><option value="card">–ù–∞ –ö–∞—Ä—Ç—É</option><option value="cash">–ù–∞ –ù–∞–ª</option></select>
        <input type="number" id="tr-sum" placeholder="–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞">
        <button class="btn btn-blue" onclick="logicTransfer()">–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
    </div>

    <div id="m-adjust" class="modal">
        <h3>‚öôÔ∏è –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—Å—Å—ã</h3>
        <select id="adj-wallet"><option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option><option value="card">–ö–∞—Ä—Ç–∞</option></select>
        <input type="number" id="adj-sum" placeholder="–°—É–º–º–∞">
        <input type="text" id="adj-note" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–∞–≤–∫–∏">
        <div class="grid">
            <button class="btn btn-green" onclick="logicAdjust(true)">–ü—Ä–∏—Ö–æ–¥ (+)</button>
            <button class="btn btn-red" onclick="logicAdjust(false)">–†–∞—Å—Ö–æ–¥ (-)</button>
        </div>
    </div>

    <div id="m-sale" class="modal">
        <h3 id="m-sale-client-name">–ü—Ä–æ–¥–∞–∂–∞</h3>
        <select id="m-sale-product"></select>
        <input type="number" id="m-sale-qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
        <select id="m-sale-method">
            <option value="cash">–û–ø–ª–∞—Ç–∞ –ù–∞–ª–æ–º</option>
            <option value="card">–û–ø–ª–∞—Ç–∞ –ö–∞—Ä—Ç–æ–π</option>
        </select>
        <div class="grid">
            <button class="btn btn-green" onclick="logicSale(true)">–û–ü–õ–ê–ß–ï–ù–û</button>
            <button class="btn btn-blue" onclick="logicSale(false)">–í –î–û–õ–ì</button>
        </div>
    </div>

    <div id="m-add-client" class="modal">
        <h3>üë• –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h3>
        <input type="text" id="cl-name" placeholder="–§–ò–û –ö–ª–∏–µ–Ω—Ç–∞">
        <input type="number" id="cl-phone" placeholder="996...">
        <button class="btn btn-blue" onclick="logicAddClient()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div id="m-pay-vendor" class="modal">
        <h3 id="v-pay-name">–ü–æ—Å—Ç–∞–≤—â–∏–∫</h3>
        <input type="number" id="v-pay-sum" placeholder="–°—É–º–º–∞ –≤—ã–ø–ª–∞—Ç—ã">
        <select id="v-pay-method"><option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option><option value="card">–ö–∞—Ä—Ç–∞</option></select>
        <button class="btn btn-green" onclick="logicPayVendor()">–í—ã–ø–ª–∞—Ç–∏—Ç—å –¥–æ–ª–≥</button>
    </div>

    <div id="m-pay-client" class="modal">
        <h3>üí∞ –ü—Ä–∏–µ–º –æ–ø–ª–∞—Ç—ã</h3>
        <input type="number" id="cl-pay-sum" placeholder="–°—É–º–º–∞">
        <select id="cl-pay-method"><option value="cash">–í –ù–∞–ª–∏—á–Ω—ã–µ</option><option value="card">–ù–∞ –ö–∞—Ä—Ç—É</option></select>
        <button class="btn btn-green" onclick="logicPayClient()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>

    <div id="m-edit-debt" class="modal">
        <h3>‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –¥–æ–ª–≥ –≤—Ä—É—á–Ω—É—é</h3>
        <input type="number" id="cl-new-debt" placeholder="–£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –¥–æ–ª–≥–∞">
        <button class="btn btn-red" onclick="logicManualDebt()">–û–±–Ω–æ–≤–∏—Ç—å —Å—É–º–º—É</button>
    </div>

    <div id="p-client-card" style="position:fixed; inset:0; background:var(--bg); z-index:2000; display:none; flex-direction:column;">
        <div style="padding:15px; background:white; display:flex; align-items:center; border-bottom:1px solid #ddd; gap:15px;">
            <button onclick="closeProfile()" style="border:0; background:none; font-size:24px;">‚¨ÖÔ∏è</button>
            <h3 id="pr-name" style="margin:0;">–ö–ª–∏–µ–Ω—Ç</h3>
        </div>
        <div style="padding:15px; flex:1; overflow-y:auto;">
            <div class="card dark-card" style="text-align:center;">
                <span class="stat-label">–¢–ï–ö–£–©–ò–ô –î–û–õ–ì</span>
                <div id="pr-debt" style="font-size:36px; font-weight:900; color:var(--danger);">0</div>
                <button class="btn" style="background:rgba(255,255,255,0.1); color:white; font-size:10px; margin-top:10px;" onclick="askPin('m-edit-debt')">–ò–ó–ú–ï–ù–ò–¢–¨ –í–†–£–ß–ù–£–Æ</button>
            </div>
            <div class="grid">
                <button class="btn btn-green" onclick="showMod('m-pay-client')">üí∞ –û–ø–ª–∞—Ç–∞</button>
                <button class="btn btn-blue" onclick="openSaleModal()">üì¶ –ü—Ä–æ–¥–∞—Ç—å</button>
            </div>
            <div class="grid" style="margin-top:12px;">
                <button class="btn btn-outline" onclick="doExport('client', 'xlsx')">Excel</button>
                <button class="btn btn-outline" onclick="doExport('client', 'pdf')">PDF</button>
            </div>
            <button class="btn btn-red" style="font-size:10px; margin-top:20px;" onclick="clearClientHistory()">–û–ß–ò–°–¢–ò–¢–¨ –ò–°–¢–û–†–ò–Æ –≠–¢–û–ì–û –ö–õ–ò–ï–ù–¢–ê</button>
            <h4 style="margin-top:25px;">üïí –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h4>
            <div id="pr-history"></div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        let db = JSON.parse(localStorage.getItem('stroy_gold_v72')) || {
            cash: 0, card: 0, profit: 0,
            stock: [], // {id, name, buy, sell, qty, vendor, method}
            clients: [], // {id, name, phone, debt, history:[]}
            vendors: {}, // {name: debt_sum}
            logs: [], // {date, msg, sum, type}
            stockLogs: [] // {date, msg, type}
        };

        const save = () => localStorage.setItem('stroy_gold_v72', JSON.stringify(db));

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function switchPage(p, btn) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.getElementById('p-' + p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(nb => nb.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function showMod(id) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById(id).style.display = 'block';
        }

        function hideMods() {
            document.getElementById('overlay').style.display = 'none';
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        // –†–µ–Ω–¥–µ—Ä –¥–∞–Ω–Ω—ã—Ö
        function render() {
            // –ö–∞—Å—Å–∞
            document.getElementById('f-cash').innerText = Math.round(db.cash).toLocaleString() + " —Å";
            document.getElementById('f-card').innerText = Math.round(db.card).toLocaleString() + " —Å";
            document.getElementById('f-profit').innerText = Math.round(db.profit).toLocaleString() + " —Å";
            
            // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É —Å–∫–ª–∞–¥–∞ –ø–æ —Ü–µ–Ω–µ –ü–†–û–î–ê–ñ–ò (item.sell –≤–º–µ—Å—Ç–æ item.buy)
            let stockSum = db.stock.reduce((total, item) => total + (item.sell * item.qty), 0);
            document.getElementById('f-stock-sum').innerText = Math.round(stockSum).toLocaleString() + " —Å";

            // –î–æ–ª–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
            let cDebtTotal = 0;
            let cListH = "";
            db.clients.forEach(c => {
                if(c.debt > 0) {
                    cDebtTotal += c.debt;
                    cListH += `<div class="history-row" style="padding:10px 15px;"><span>${c.name}</span><b style="color:var(--danger)">${Math.round(c.debt)}</b></div>`;
                }
            });
            document.getElementById('sum-c-debt').innerText = Math.round(cDebtTotal).toLocaleString();
            document.getElementById('list-c-debts').innerHTML = cListH || "<small style='padding:15px'>–î–æ–ª–∂–Ω–∏–∫–æ–≤ –Ω–µ—Ç</small>";

            // –î–æ–ª–≥–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
            let vDebtTotal = 0;
            let vListH = "";
            for(let vendor in db.vendors) {
                if(db.vendors[vendor] > 0) {
                    vDebtTotal += db.vendors[vendor];
                    vListH += `<div class="history-row" style="padding:10px 15px;">
                        <span>${vendor}</span>
                        <div><b style="color:var(--primary); margin-right:10px;">${Math.round(db.vendors[vendor])}</b>
                        <button onclick="prepPayVendor('${vendor}')" style="border:0; background:var(--primary); color:white; border-radius:5px; padding:2px 8px; font-size:10px;">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button></div>
                    </div>`;
                }
            }
            document.getElementById('sum-v-debt').innerText = Math.round(vDebtTotal).toLocaleString();
            document.getElementById('list-v-debts').innerHTML = vListH || "<small style='padding:15px'>–î–æ–ª–≥–æ–≤ –Ω–µ—Ç</small>";

            // –ñ—É—Ä–Ω–∞–ª –∫–∞—Å—Å—ã
            document.getElementById('fin-history').innerHTML = db.logs.map(l => `
                <div class="history-row" style="padding:10px 15px;">
                    <div><small style="color:#94a3b8">${l.date}</small><br><b>${l.msg}</b></div>
                    <b style="color:${l.sum >= 0 ? 'var(--success)' : 'var(--danger)'}">${l.sum > 0 ? '+' : ''}${Math.round(l.sum)}</b>
                </div>
            `).join('');

            // –°–∫–ª–∞–¥
            document.getElementById('stock-list').innerHTML = db.stock.map((item, idx) => {
                let color = item.method === 'debt' ? 'var(--danger)' : (item.method === 'cash' ? 'var(--success)' : 'var(--primary)');
                return `
                <div class="card" onclick="openStockItem(${idx})">
                    <span class="badge" style="background:${color}">${item.method}</span>
                    <b style="font-size:15px;">${item.name}</b><br>
                    <small style="color:#94a3b8">–ó–∞–∫—É–ø: ${item.buy} | –ü—Ä–æ–¥–∞–∂–∞: ${item.sell}</small>
                    <div style="font-size:20px; font-weight:800; margin-top:8px;">${item.qty} —à—Ç</div>
                    <small style="color:var(--primary)">${item.vendor}</small>
                </div>
            `}).join('');

            document.getElementById('stock-history').innerHTML = db.stockLogs.map(l => `<div class="history-row" style="padding:8px 15px;">${l}</div>`).join('');

            // –ö–ª–∏–µ–Ω—Ç—ã
            document.getElementById('clients-list').innerHTML = db.clients.map((c, idx) => `
                <div class="card" onclick="openProfile(${idx})">
                    <b>${c.name}</b>
                    <div style="float:right; color:${c.debt > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight:bold;">${Math.round(c.debt)} —Å</div>
                    <br><small style="color:#94a3b8">${c.phone}</small>
                </div>
            `).join('');
        }

        // --- –õ–û–ì–ò–ö–ê –°–ö–õ–ê–î–ê ---
        function logicAddStock() {
            const name = document.getElementById('st-name').value.trim();
            const buy = Number(document.getElementById('st-buy').value);
            const sell = Number(document.getElementById('st-sell').value);
            const qty = Number(document.getElementById('st-qty').value);
            const vendor = document.getElementById('st-vendor').value.trim() || "–û–±—ã—á–Ω—ã–π";
            const method = document.getElementById('st-pay-method').value;

            if(!name || qty <= 0) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ!");
            const total = buy * qty;

            // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–∏–Ω—É—Å–∞
            if(method === 'cash' && db.cash < total) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ª–∏—á–Ω—ã—Ö!");
            if(method === 'card' && db.card < total) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –Ω–∞ –∫–∞—Ä—Ç–µ!");

            // –°–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥
            if(method === 'cash') db.cash -= total;
            if(method === 'card') db.card -= total;
            if(method === 'debt') {
                db.vendors[vendor] = (db.vendors[vendor] || 0) + total;
            } else {
                addLog(`–ó–∞–∫—É–ø: ${name} (${qty}—à—Ç)`, -total);
            }

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–∞
            let existing = db.stock.find(i => i.name.toLowerCase() === name.toLowerCase() && i.method === method);
            if(existing) {
                existing.qty += qty;
                existing.buy = buy; // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é
                existing.sell = sell;
            } else {
                db.stock.push({name, buy, sell, qty, vendor, method});
            }

            db.stockLogs.unshift(`${new Date().toLocaleString()} | –ü–†–ò–•–û–î: ${name} (+${qty} —à—Ç) | –ü–æ—Å—Ç: ${vendor} | ${method.toUpperCase()}`);
            
            save(); hideMods(); render();
            document.getElementById('st-name').value = "";
        }

        function openStockItem(idx) {
            db.activeStockIdx = idx;
            const item = db.stock[idx];
            document.getElementById('m-st-title').innerText = item.name;
            document.getElementById('m-st-info').innerHTML = `
                <p>–ù–∞ —Å–∫–ª–∞–¥–µ: <b>${item.qty}</b> —à—Ç</p>
                <p>–ú–µ—Ç–æ–¥ –∑–∞–∫—É–ø–∞: <b>${item.method.toUpperCase()}</b></p>
                <p>–ü–æ—Å—Ç–∞–≤—â–∏–∫: <b>${item.vendor}</b></p>
            `;
            showMod('m-stock-item');
        }

        function logicReturnStock() {
            const q = Number(document.getElementById('m-st-return-qty').value);
            const item = db.stock[db.activeStockIdx];
            if(q <= 0 || q > item.qty) return alert("–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!");

            const refundSum = item.buy * q;
            
            if(item.method === 'debt') {
                db.vendors[item.vendor] -= refundSum;
            } else {
                if(item.method === 'cash') db.cash += refundSum;
                else db.card += refundSum;
                addLog(`–í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫—É: ${item.name}`, refundSum);
            }

            item.qty -= q;
            if(item.qty <= 0) db.stock.splice(db.activeStockIdx, 1);
            
            db.stockLogs.unshift(`${new Date().toLocaleString()} | –í–û–ó–í–†–ê–¢: ${item.name} (-${q} —à—Ç) | –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω`);
            save(); hideMods(); render();
        }

        // --- –õ–û–ì–ò–ö–ê –ö–õ–ò–ï–ù–¢–û–í ---
        function logicAddClient() {
            const n = document.getElementById('cl-name').value.trim();
            const p = document.getElementById('cl-phone').value.trim();
            if(!n) return;
            if(db.clients.find(c => c.phone === p && p !== "")) return alert("–ö–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ –µ—Å—Ç—å!");
            
            db.clients.push({ name: n, phone: p, debt: 0, history: [] });
            save(); hideMods(); render();
            document.getElementById('cl-name').value = "";
        }

        function openProfile(idx) {
            db.activeClientIdx = idx;
            const c = db.clients[idx];
            document.getElementById('p-client-card').style.display = 'flex';
            document.getElementById('pr-name').innerText = c.name;
            document.getElementById('pr-debt').innerText = Math.round(c.debt) + " —Å";
            
            document.getElementById('pr-history').innerHTML = c.history.map(h => `
                <div class="history-row" style="padding:10px 0;">
                    <div><small>${h.date}</small><br><b>${h.msg}</b></div>
                    <div style="text-align:right">
                        <b style="color:${h.sum.toString().includes('+') ? 'var(--success)' : 'var(--danger)'}">${h.sum}</b><br>
                        <small>–æ—Å—Ç: ${h.balance}</small>
                    </div>
                </div>
            `).reverse().join('');
        }

        function closeProfile() {
            document.getElementById('p-client-card').style.display = 'none';
            render();
        }

        function logicPayClient() {
            const s = Number(document.getElementById('cl-pay-sum').value);
            const m = document.getElementById('cl-pay-method').value;
            const c = db.clients[db.activeClientIdx];
            if(s <= 0) return;

            if(m === 'cash') db.cash += s; else db.card += s;
            c.debt -= s;
            c.history.push({ date: new Date().toLocaleString(), msg: `–û–ø–ª–∞—Ç–∞ –¥–æ–ª–≥–∞ (${m})`, sum: "+" + s, balance: c.debt });
            addLog(`–û–ø–ª–∞—Ç–∞ –¥–æ–ª–≥–∞: ${c.name}`, s);
            
            save(); hideMods(); openProfile(db.activeClientIdx);
        }

        function openSaleModal() {
            const sel = document.getElementById('m-sale-product');
            sel.innerHTML = db.stock.map((item, i) => `<option value="${i}">${item.name} (${item.qty}—à—Ç) - ${item.sell}—Å</option>`).join('');
            document.getElementById('m-sale-client-name').innerText = "–ü—Ä–æ–¥–∞–∂–∞ –¥–ª—è: " + db.clients[db.activeClientIdx].name;
            showMod('m-sale');
        }

        function logicSale(isPaid) {
            const sIdx = document.getElementById('m-sale-product').value;
            const q = Number(document.getElementById('m-sale-qty').value);
            const m = document.getElementById('m-sale-method').value;
            const c = db.clients[db.activeClientIdx];
            const item = db.stock[sIdx];

            if(!item || q <= 0 || q > item.qty) return alert("–û—à–∏–±–∫–∞ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ!");
            
            const total = item.sell * q;
            const profit = (item.sell - item.buy) * q;
            db.profit += profit;
            item.qty -= q;

            if(isPaid) {
                if(m === 'cash') db.cash += total; else db.card += total;
                addLog(`–ü—Ä–æ–¥–∞–∂–∞: ${item.name}`, total);
                c.history.push({ date: new Date().toLocaleString(), msg: `–ö—É–ø–∏–ª: ${item.name} (–û–ø–ª–∞—Ç–∏–ª)`, sum: "+" + total, balance: c.debt });
            } else {
                c.debt += total;
                c.history.push({ date: new Date().toLocaleString(), msg: `–ö—É–ø–∏–ª: ${item.name} (–í –î–û–õ–ì)`, sum: "-" + total, balance: c.debt });
            }

            if(item.qty <= 0) db.stock.splice(sIdx, 1);
            save(); hideMods(); openProfile(db.activeClientIdx);
        }

        function logicManualDebt() {
            const newVal = Number(document.getElementById('cl-new-debt').value);
            const c = db.clients[db.activeClientIdx];
            c.debt = newVal;
            c.history.push({ date: new Date().toLocaleString(), msg: "–†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ–ª–≥–∞", sum: "!", balance: newVal });
            save(); hideMods(); openProfile(db.activeClientIdx);
        }

        // --- –õ–û–ì–ò–ö–ê –§–ò–ù–ê–ù–°–û–í ---
        function logicTransfer() {
            const sum = Number(document.getElementById('tr-sum').value);
            const from = document.getElementById('tr-from').value;
            const to = document.getElementById('tr-to').value;

            if(sum <= 0 || from === to) return alert("–û—à–∏–±–∫–∞!");
            if(from === 'cash' && db.cash < sum) return alert("–ú–∞–ª–æ –Ω–∞–ª–∏—á–Ω—ã—Ö!");
            if(from === 'card' && db.card < sum) return alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥ –Ω–∞ –∫–∞—Ä—Ç–µ!");

            if(from === 'cash') { db.cash -= sum; db.card += sum; }
            else { db.card -= sum; db.cash += sum; }

            addLog(`–ü–µ—Ä–µ–≤–æ–¥: ${from} ‚Üí ${to}`, 0);
            save(); hideMods(); render();
        }

        function logicAdjust(isPlus) {
            const sum = Number(document.getElementById('adj-sum').value);
            const wal = document.getElementById('adj-wallet').value;
            const note = document.getElementById('adj-note').value || "–ü—Ä–∞–≤–∫–∞";

            if(sum <= 0) return;
            if(!isPlus && (wal === 'cash' ? db.cash : db.card) < sum) return alert("–ù–µ–ª—å–∑—è —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å!");

            if(isPlus) {
                if(wal === 'cash') db.cash += sum; else db.card += sum;
                addLog(`–ü—Ä–∞–≤–∫–∞ (+): ${note}`, sum);
            } else {
                if(wal === 'cash') db.cash -= sum; else db.card -= sum;
                addLog(`–ü—Ä–∞–≤–∫–∞ (-): ${note}`, -sum);
            }
            save(); hideMods(); render();
        }

        function prepPayVendor(vendor) {
            db.activeVendor = vendor;
            document.getElementById('v-pay-name').innerText = vendor + " (–î–æ–ª–≥: " + db.vendors[vendor] + ")";
            showMod('m-pay-vendor');
        }

        function logicPayVendor() {
            const sum = Number(document.getElementById('v-pay-sum').value);
            const meth = document.getElementById('v-pay-method').value;
            if(sum <= 0 || sum > db.vendors[db.activeVendor]) return alert("–°—É–º–º–∞ –Ω–µ–≤–µ—Ä–Ω–∞!");
            
            if(meth === 'cash' && db.cash < sum) return alert("–ú–∞–ª–æ –Ω–∞–ª!");
            if(meth === 'card' && db.card < sum) return alert("–ú–∞–ª–æ –∫–∞—Ä—Ç–∞!");

            if(meth === 'cash') db.cash -= sum; else db.card -= sum;
            db.vendors[db.activeVendor] -= sum;
            addLog(`–í—ã–ø–ª–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É: ${db.activeVendor}`, -sum);
            save(); hideMods(); render();
        }

        // --- –°–ï–†–í–ò–°–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function addLog(msg, sum) {
            db.logs.unshift({ date: new Date().toLocaleString(), msg, sum });
        }

        function askPin(nextMod) {
            db.pendingMod = nextMod;
            showMod('m-pin');
        }

        function checkPin() {
            if(document.getElementById('pin-val').value === "1234") {
                hideMods();
                showMod(db.pendingMod);
            } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù!");
            document.getElementById('pin-val').value = "";
        }

        function clearHistory(key) {
            if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—é, –±–∞–ª–∞–Ω—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.")) {
                db[key] = [];
                save(); render();
            }
        }

        function clearClientHistory() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?")) {
                db.clients[db.activeClientIdx].history = [];
                save(); openProfile(db.activeClientIdx);
            }
        }

        function doExport(type, format) {
            let title = "";
            let html = "";

            // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if(type === 'fin') {
                title = "–û—Ç—á–µ—Ç –ø–æ –∫–∞—Å—Å–µ";
                html = `<table border="1" style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#eee"><th>–î–∞—Ç–∞</th><th>–°–æ–±—ã—Ç–∏–µ</th><th>–°—É–º–º–∞</th></tr></thead>
                    <tbody>${db.logs.map(l => `<tr><td>${l.date}</td><td>${l.msg}</td><td>${l.sum}</td></tr>`).join('')}</tbody>
                </table>`;
            } else if(type === 'stock') {
                title = "–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∫–ª–∞–¥–∞";
                html = `<table border="1" style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#eee"><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–ó–∞–∫—É–ø</th><th>–ü—Ä–æ–¥.</th><th>–ü–æ—Å—Ç.</th></tr></thead>
                    <tbody>${db.stock.map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.buy}</td><td>${i.sell}</td><td>${i.vendor}</td></tr>`).join('')}</tbody>
                </table>`;
            } else if(type === 'client') {
                const c = db.clients[db.activeClientIdx];
                title = "–ò—Å—Ç–æ—Ä–∏—è: " + c.name;
                html = `<table border="1" style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#eee"><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–°—É–º–º–∞</th><th>–û—Å—Ç–∞—Ç–æ–∫</th></tr></thead>
                    <tbody>${c.history.map(h => `<tr><td>${h.date}</td><td>${h.msg}</td><td>${h.sum}</td><td>${h.balance}</td></tr>`).join('')}</tbody>
                </table>`;
            }

            if(format === 'xlsx') {
                // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª (–æ–Ω –ø–æ–Ω–∏–º–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π)
                const table = document.createElement('div');
                table.innerHTML = html;
                const ws = XLSX.utils.table_to_sheet(table.querySelector('table'));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "StroyPro");
                XLSX.writeFile(wb, `${title}.xlsx`);
            } 
            else if(format === 'pdf') {
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ —Å–∫—Ä—ã—Ç–æ–µ –æ–∫–Ω–æ (–†—É—Å—Å–∫–∏–π —è–∑—ã–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!)
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>' + title + '</title>');
                printWindow.document.write('<style>body{font-family:sans-serif;padding:20px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ddd;padding:8px;text-align:left;} th{background:#3b82f6;color:white;}</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h2>' + title + '</h2>');
                printWindow.document.write('<p>–î–∞—Ç–∞: ' + new Date().toLocaleString() + '</p>');
                printWindow.document.write(html);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print(); // –û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ PDF
            }
        }

        // –ë–≠–ö–ê–ü
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "stroy_backup.json");
            dlAnchorElem.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = function() {
                db = JSON.parse(reader.result);
                save(); location.reload();
            };
            reader.readAsText(input.files[0]);
        }

        render();
    </script>
</body>
</html>
