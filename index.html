<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STROY ELITE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0f18; --card: #161f30; --p: #3b82f6; --s: #10b981; 
            --d: #f43f5e; --txt: #ffffff; --sub: #94a3b8; --grad: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }
        * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--txt); height: 100vh; overflow: hidden; }
        header { height: 70px; background: var(--card); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #2d3a4f; }
        .container { height: calc(100vh - 150px); overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .page { display: none; } .page.active { display: block; }
        .biz-card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #2d3a4f; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .sq-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .sq-card { aspect-ratio: 1/1; background: var(--card); border-radius: 24px; border: 1px solid #2d3a4f; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; padding: 10px; }
        .badge { position: absolute; top: 10px; right: 10px; font-size: 8px; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        .btn { border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-p { background: var(--grad); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        .btn-g { background: #2d3a4f; color: var(--sub); }
        input, select { width: 100%; background: #0f172a; border: 1px solid #2d3a4f; padding: 15px; border-radius: 12px; color: white; margin-top: 10px; font-size: 16px; }
        nav { height: 80px; background: var(--card); display: flex; border-top: 1px solid #2d3a4f; position: fixed; bottom: 0; width: 100%; z-index: 100; padding: 0 10px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--sub); }
        .nav-item.active { color: var(--p); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; backdrop-filter: blur(10px); }
        .modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-radius: 32px 32px 0 0; padding: 30px; z-index: 2001; border-top: 2px solid var(--p); max-height: 80vh; overflow-y: auto; }
        .modal.active { display: block; }
        .pos-wrap { display: flex; gap: 10px; height: 60vh; }
        .pos-left { flex: 1.2; overflow-y: auto; }
        .pos-right { flex: 1; background: #000; border-radius: 20px; padding: 10px; display: flex; flex-direction: column; border: 1px solid var(--p); }
        #welcome-screen {position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; overflow: hidden; z-index: 99999; }
        .welding-sparks {position: absolute; top: 150px; left: 73%; width: 2px; height: 2px; background: #fff; box-shadow: 0 0 20px 5px #3b82f6, 0 0 40px 10px #fff; border-radius: 50%; opacity: 0; animation: spark-flash 2s infinite; }
        @keyframes spark-flash { 0%, 90% { opacity: 0; } 92% { opacity: 1; transform: scale(1.5); } 95% { opacity: 0; transform: scale(0); } }
        .city-parallax { position: absolute; bottom: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .tower-extreme { position: absolute; bottom: 0; background: linear-gradient(to top, #050505, #111); border-top: 1px solid #222; }
        .tower-extreme::before { content: ""; position: absolute; inset: 0; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 8px 12px; }
        .crane-girder { position: absolute; top: 40px; width: 120%; height: 20px; background: repeating-linear-gradient(-45deg, #eab308, #eab308 15px, #000 15px, #000 30px); box-shadow: 0 10px 20px #000; z-index: 10; }
        .rope-system { position: absolute; right: 25%; top: 20px; width: 40px; height: 180px; border-left: 2px dashed #444; border-right: 2px dashed #444; transform-origin: top center; animation: heavy-swing 5s ease-in-out infinite; }
        .giant-l { position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%); font-size: 100px; font-weight: 950; color: #facc15; text-shadow: 0 0 30px rgba(250, 204, 21, 0.5), 5px 5px 0 #854d0e; }
        @keyframes heavy-swing { 0%, 100% { transform: rotate(-1.5deg) translateY(0); } 50% { transform: rotate(1.5deg) translateY(-5px); } }
        .ui-footer-industrial { position: relative; z-index: 100; margin-top: auto; padding: 25px; background: linear-gradient(to top, #000 70%, transparent); }
        .btn-steel { width: 100%; height: 75px; margin-bottom: 15px; border-radius: 2px; border: 2px solid #333; font-size: 18px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; position: relative; }
        .btn-gold { background: linear-gradient(#facc15, #a16207); color: #000; border: none; box-shadow: 0 6px 0 #713f12, 0 15px 30px rgba(250, 204, 21, 0.2); }
        .btn-gold:active { transform: translateY(3px); box-shadow: 0 3px 0 #713f12; }
        .btn-iron { background: #111; color: #666; border-color: #222; }  
    </style>
</head>
<body>

<div id="welcome-screen">
    <div class="city-parallax">
        <div class="tower-extreme" style="left: 0%; width: 25%; height: 40%; opacity: 0.3;"></div>
        <div class="tower-extreme" style="left: 20%; width: 30%; height: 75%; opacity: 0.6;"></div>
        <div class="tower-extreme" style="left: 55%; width: 20%; height: 55%; opacity: 0.4;"></div>
        <div class="tower-extreme" style="right: 0%; width: 25%; height: 85%; opacity: 0.8;"></div>
    </div>
    <div class="crane-girder"></div>
    <div class="welding-sparks"></div>
    <div class="rope-system">
        <div class="giant-l">L</div>
    </div>
    <div style="position: relative; z-index: 20; text-align: center; margin-top: 240px; pointer-events: none;">
        <h1 style="color: #fff; font-size: 45px; font-weight: 900; margin: 0; letter-spacing: -2px;">
            STROY E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ITE
        </h1>
        <div style="color: #facc15; font-size: 10px; font-weight: 800; letter-spacing: 10px; opacity: 0.5;">
            HEAVY INDUSTRIES
        </div>
    </div>
    <div id="biz-list" style="flex:1; overflow-y:auto; position: relative; z-index: 100; margin: 20px;"></div>
    <div class="ui-footer-industrial" style="position: relative; z-index: 200;">
        <button class="btn-steel btn-gold" onclick="addBiz()">
            –ù–û–í–´–ô –ü–†–û–ï–ö–¢
        </button>
        <button class="btn-steel btn-iron" onclick="document.getElementById('wipe-load-input').click()">
            –ó–ê–ì–†–£–ó–ò–¢–¨ –ë–ê–ó–£
        </button>
        <input type="file" id="wipe-load-input" style="display:none" onchange="wipeAndLoad(event)">
    </div>
</div>

<header>
    <div id="active-title" style="font-weight: 800; text-transform: uppercase;">–§–ò–õ–ò–ê–õ</div>
    <button class="btn-d" style="padding: 8px 15px;" onclick="location.reload()">–í–´–•–û–î</button>
</header>

<div class="container">
    <div id="p-cash" class="page active">
        <div class="biz-card" style="background: var(--grad); border:none; flex-direction:column; align-items:center; text-align:center">
            <small style="text-transform:uppercase; letter-spacing:1px">–û–±—â–∏–π –ë–∞–ª–∞–Ω—Å</small>
            <h1 id="c-total" style="font-size:42px; margin:5px 0">0</h1>
            <div style="opacity:0.9">–ù–∞–ª: <b id="c-cash">0</b> | –ö–∞—Ä—Ç–∞: <b id="c-card">0</b></div>
        </div>
        <div class="sq-grid">
            <div class="sq-card"><small>–ü–†–ò–ë–´–õ–¨</small><h2 id="c-profit" style="color:var(--s)">0</h2></div>
            <div class="sq-card"><small>–î–û–õ–ì–ò –ö–õ–ò–ï–ù–¢–û–í</small><h2 id="c-debt-total" style="color:var(--d)">0</h2></div>
            <div class="sq-card"><small>–°–ö–õ–ê–î (–ó–∞–∫—É–ø)</small><h3 id="c-stock-in">0</h3></div>
            <div class="sq-card"><small>–°–ö–õ–ê–î (–ü—Ä–æ–¥–∞–∂–∞)</small><h3 id="c-stock-out" style="color:var(--p)">0</h3></div>
        </div>
        <div class="sq-grid" style="margin-top:15px">
            <button class="btn btn-g" onclick="openMod('m-transfer')">‚áÖ –ü–ï–†–ï–í–û–î</button>
            <button class="btn btn-g" onclick="askPin('m-adj')">‚öôÔ∏è –ü–†–ê–í–ö–ê</button>
        </div>
        <button class="btn btn-p" style="width:100%; margin-top:15px" onclick="exportPDF('cash')">üìÑ –≠–ö–°–ü–û–†–¢ –ö–ê–°–°–´ (PDF)</button>
        <button class="btn btn-g" style="width:100%; margin-top:10px; border: 1px dashed var(--p)" onclick="exportSingleBiz()">üì• –°–û–•–†–ê–ù–ò–¢–¨ –§–ò–õ–ò–ê–õ–ê</button>
        <div style="margin-top:25px; display:flex; justify-content:space-between; align-items:center">
            <b>–ò–°–¢–û–†–ò–Ø –û–ü–ï–†–ê–¶–ò–ô</b>
            <button class="btn-d" style="padding:5px 10px; font-size:10px; border-radius:8px" onclick="clearLogs('logs')">–û–ß–ò–°–¢–ò–¢–¨</button>
        </div>
        <div id="cash-logs" style="margin-top:10px"></div>
    </div>

    <div id="p-stock" class="page">
        <button class="btn btn-p" style="width:100%" onclick="openMod('m-buy')">+ –ó–ê–ö–£–ü–ò–¢–¨ –¢–û–í–ê–†</button>
        <div id="stock-list" class="sq-grid" style="margin-top:20px"></div>
        <button class="btn btn-p" style="width:100%; margin-top:20px" onclick="exportPDF('stock')">üìÑ –≠–ö–°–ü–û–†–¢ –°–ö–õ–ê–î–ê (PDF)</button>
        <div id="stock-logs" style="margin-top:20px; font-size:11px; color:var(--sub)"></div>
    </div>

    <div id="p-sales" class="page">
        <div id="pos-select-c">
            <h3 style="text-align:center">–í–´–ë–ï–†–ò–¢–ï –ö–õ–ò–ï–ù–¢–ê –î–õ–Ø –ü–†–û–î–ê–ñ–ò:</h3>
            <div id="sales-clients" class="sq-grid"></div>
        </div>
        <div id="pos-ui" style="display:none">
            <div class="pos-wrap">
                <div class="pos-left" id="pos-stock-list"></div>
                <div class="pos-right">
                    <b style="color:var(--p)">–ö–û–†–ó–ò–ù–ê</b>
                    <div id="pos-basket" style="flex:1; overflow:auto; font-size:11px; margin:10px 0"></div>
                    <small>–ò–¢–û–ì–û:</small>
                    <h2 id="pos-total" style="margin:5px 0">0</h2>
                    <button class="btn btn-s" onclick="finishSale('cash')" style="width:100%; margin-bottom:5px">–ù–ê–õ</button>
                    <button class="btn btn-p" onclick="finishSale('card')" style="width:100%; margin-bottom:5px">–ö–ê–†–¢–ê</button>
                    <button class="btn btn-d" onclick="finishSale('debt')" style="width:100%">–í –î–û–õ–ì</button>
                </div>
            </div>
            <button class="btn btn-g" onclick="closePos()" style="width:100%; margin-top:15px">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <div id="p-clients" class="page">
        <button class="btn btn-p" style="width:100%" onclick="openMod('m-add-c')">+ –î–û–ë–ê–í–ò–¢–¨ –ö–õ–ò–ï–ù–¢–ê</button>
        <div id="client-list" class="sq-grid" style="margin-top:20px"></div>
    </div>

    <div id="p-debts" class="page">
        <div style="padding:15px; background:rgba(244,63,94,0.1); border-radius:24px; border:1px solid var(--d); margin-bottom:20px">
            <h3 style="color:var(--d); margin-top:0">–ú–´ –î–û–õ–ñ–ù–´ –ü–û–°–¢–ê–í–©–ò–ö–ê–ú</h3>
            <div id="v-debt-list"></div>
        </div>
        <div style="padding:15px; background:rgba(59,130,246,0.1); border-radius:24px; border:1px solid var(--p)">
            <h3 style="color:var(--p); margin-top:0">–ù–ê–ú –î–û–õ–ñ–ù–´ –ö–õ–ò–ï–ù–¢–´</h3>
            <div id="c-debt-list"></div>
        </div>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="tab('cash', this)"><i>üè†</i>–ö–ê–°–°–ê</div>
    <div class="nav-item" onclick="tab('stock', this)"><i>üì¶</i>–°–ö–õ–ê–î</div>
    <div class="nav-item" onclick="tab('sales', this)"><i>‚ö°</i>–ü–†–û–î–ê–ñ–ò</div>
    <div class="nav-item" onclick="tab('clients', this)"><i>üë•</i>–ö–õ–ò–ï–ù–¢–´</div>
    <div class="nav-item" onclick="tab('debts', this)"><i>üö©</i>–î–û–õ–ì–ò</div>
</nav>

<div class="overlay" id="overlay" onclick="closeMod()"></div>

<div class="modal" id="m-pin">
    <h3 style="text-align:center">–í–í–ï–î–ò–¢–ï PIN</h3>
    <input type="password" id="pin-in" maxlength="4" style="text-align:center; font-size:32px; letter-spacing:10px">
    <button class="btn btn-p" style="width:100%; margin-top:20px" onclick="checkPin()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
</div>

<div class="modal" id="m-add-c">
    <h3>–ù–û–í–´–ô –ö–õ–ò–ï–ù–¢</h3>
    <input type="text" id="nc-n" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
    <input type="number" id="nc-p" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
    <button class="btn btn-p" style="width:100%; margin-top:20px" onclick="addClient()">–°–û–ó–î–ê–¢–¨</button>
</div>

<div class="modal" id="m-adj">
    <h3>–ü–†–ê–í–ö–ê –ö–ê–°–°–´</h3>
    <select id="ad-m"><option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option><option value="card">–ö–∞—Ä—Ç–∞</option></select>
    <input type="number" id="ad-s" placeholder="–°—É–º–º–∞">
    <input type="text" id="ad-n" placeholder="–ü—Ä–∏—á–∏–Ω–∞">
    <div class="sq-grid" style="margin-top:20px">
        <button class="btn btn-s" onclick="doAdj(true)">–î–û–ë–ê–í–ò–¢–¨</button>
        <button class="btn btn-d" onclick="doAdj(false)">–£–ë–ê–í–ò–¢–¨</button>
    </div>
</div>

<div class="modal" id="m-buy">
    <h3>–ó–ê–ö–£–ü–ö–ê –¢–û–í–ê–†–ê</h3>
    <input type="text" id="b-n" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
    <div class="sq-grid">
        <input type="number" id="b-pi" placeholder="–ó–∞–∫—É–ø —Ü–µ–Ω–∞">
        <input type="number" id="b-po" placeholder="–ü—Ä–æ–¥–∞–∂–∞ —Ü–µ–Ω–∞">
    </div>
    <input type="number" id="b-q" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <input type="text" id="b-v" placeholder="–ü–æ—Å—Ç–∞–≤—â–∏–∫">
    <select id="b-m">
        <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
        <option value="card">–ö–∞—Ä—Ç–∞</option>
        <option value="debt">–í –¥–æ–ª–≥</option>
    </select>
    <button class="btn btn-p" style="width:100%; margin-top:20px" onclick="doBuy()">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–£–ü–ö–£</button>
</div>

<div class="modal" id="m-item-opt">
    <h3 id="mi-name">–¢–û–í–ê–†</h3>
    <input type="number" id="mi-q" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <input type="text" id="mi-r" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)">
    <div class="sq-grid" style="margin-top:20px">
        <button class="btn btn-d" onclick="doItemAction('return')">–í–û–ó–í–†–ê–¢</button>
        <button class="btn btn-g" onclick="doItemAction('self')">–í —É–±—ã—Ç–æ–∫</button>
    </div>
</div>

<div class="modal" id="m-transfer">
    <h3>–ü–ï–†–ï–í–û–î –ú–ï–ñ–î–£ –°–ß–ï–¢–ê–ú–ò</h3>
    <select id="tr-f"><option value="cash">–° –ù–∞–ª–∏—á–Ω—ã—Ö</option><option value="card">–° –ö–∞—Ä—Ç—ã</option></select>
    <select id="tr-t"><option value="card">–ù–∞ –ö–∞—Ä—Ç—É</option><option value="cash">–í –ù–∞–ª–∏—á–Ω—ã–µ</option></select>
    <input type="number" id="tr-s" placeholder="–°—É–º–º–∞">
    <button class="btn btn-p" style="width:100%; margin-top:20px" onclick="doTransfer()">–ü–ï–†–ï–í–ï–°–¢–ò</button>
</div>

<div id="c-profile" style="position:fixed; inset:0; background:var(--bg); z-index:1500; display:none; flex-direction:column">
    <header>
        <button onclick="document.getElementById('c-profile').style.display='none'" style="background:none; border:none; color:white; font-size:24px">‚¨Ö</button>
        <b id="cp-name">–ö–õ–ò–ï–ù–¢</b>
        <button class="btn-d" style="padding:5px 15px; font-size:12px" onclick="deleteClient()">–£–î–ê–õ–ò–¢–¨</button>
    </header>
    <div style="padding:20px; flex:1; overflow-y:auto; padding-bottom:50px">
        <div class="biz-card" style="flex-direction:column; align-items:center">
            <small>–¢–ï–ö–£–©–ò–ô –î–û–õ–ì</small>
            <h1 id="cp-debt" style="color:var(--d); font-size:48px; margin:10px 0">0</h1>
            <a id="cp-call" class="btn btn-p" style="text-decoration:none; display:block; width:100%; text-align:center">üìû –ü–û–ó–í–û–ù–ò–¢–¨</a>
        </div>
        <div class="sq-grid" style="margin:20px 0">
            <button class="btn btn-g" onclick="askPin('m-cp-edit')">‚öôÔ∏è –ü–†–ê–í–ö–ê</button>
            <button class="btn btn-s" onclick="openMod('m-cp-pay')">üí∞ –ü–†–ò–ù–Ø–¢–¨ –û–ü–õ–ê–¢–£</button>
        </div>
        <button class="btn btn-p" style="width:100%" onclick="exportPDF('client')">üìÑ PDF –û–¢–ß–ï–¢ –ü–û –ö–õ–ò–ï–ù–¢–£</button>
        <div id="cp-history" style="margin-top:20px"></div>
    </div>
</div>

<div class="modal" id="m-cp-edit"><h3>–ò–ó–ú–ï–ù–ò–¢–¨ –°–£–ú–ú–£ –î–û–õ–ì–ê</h3><input type="number" id="cpe-s"><button class="btn btn-d" onclick="doClientEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button></div>
<div class="modal" id="m-cp-pay"><h3>–ü–†–ò–ù–Ø–¢–¨ –û–ü–õ–ê–¢–£ –î–û–õ–ì–ê</h3><input type="number" id="cpp-s"><select id="cpp-m"><option value="cash">–í –ù–∞–ª–∏—á–Ω—ã–µ</option><option value="card">–ù–∞ –ö–∞—Ä—Ç—É</option></select><button class="btn btn-s" onclick="doClientPay()">–û–§–û–†–ú–ò–¢–¨</button></div>
<div class="modal" id="m-pay-vendor"><h3>–û–ü–õ–ê–¢–ò–¢–¨ –ü–û–°–¢–ê–í–©–ò–ö–£</h3><input type="number" id="pv-s"><div class="sq-grid"><button class="btn btn-s" onclick="doPayVendor('cash')">–ù–ê–õ</button><button class="btn btn-p" onclick="doPayVendor('card')">–ö–ê–†–¢–ê</button></div></div>

<script>
    const { jsPDF } = window.jspdf;
    let businesses = JSON.parse(localStorage.getItem('STROY_V26_DB')) || [];
    let activeIdx = -1, db = {}, cart = [];

    const save = () => localStorage.setItem('STROY_V26_DB', JSON.stringify(businesses));
    const dt = () => {
        const d = new Date();
        return `${d.getDate().toString().padStart(2,'0')}.${(d.getMonth()+1).toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    };

    function renderBizList() {
        const listCont = document.getElementById('biz-list');
        if (businesses.length === 0) {
            listCont.innerHTML = `<div style="text-align:center; color:var(--sub); margin-top:20px; font-size:14px">–§–∏–ª–∏–∞–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç...</div>`;
        } else {
            listCont.innerHTML = businesses.map((b, i) => `
                <div class="biz-card" onclick="selectBiz(${i})" style="cursor:pointer; margin-bottom:12px">
                    <div style="flex:1">
                        <b style="font-size:18px">${b.name}</b>
                        <div style="font-size:10px; color:var(--sub); margin-top:5px">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏</div>
                    </div>
                    <span class="btn-d" style="padding:10px 15px; border-radius:12px; z-index:10" 
                          onclick="event.stopPropagation(); deleteBiz(${i})">‚úï</span>
                </div>`).join('');
        }
    }

    function wipeAndLoad(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // –°–õ–£–ß–ê–ô 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—É—é –±–∞–∑—É (–º–∞—Å—Å–∏–≤ —Ñ–∏–ª–∏–∞–ª–æ–≤)
            if (Array.isArray(data)) {
                businesses = data;
                alert("–°–ò–°–¢–ï–ú–ê: –ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (" + data.length + " –æ–±—ä–µ–∫—Ç–æ–≤).");
            } 
            // –°–õ–£–ß–ê–ô 2: –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–¥–∏–Ω —Ñ–∏–ª–∏–∞–ª (–æ–±—ä–µ–∫—Ç), —Å–æ–∑–¥–∞–Ω–Ω—ã–π —á–µ—Ä–µ–∑ exportSingleBiz
            else if (data && typeof data === 'object' && data.name) {
                businesses.push(data);
                alert("–°–ò–°–¢–ï–ú–ê: –§–∏–ª–∏–∞–ª '" + data.name + "' –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫.");
            } 
            else {
                alert("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON.");
                return;
            }

            // –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï
            localStorage.setItem('STROY_V26_DB', JSON.stringify(businesses));
            renderBizList(); 

        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", err);
            alert("–§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–º JSON.");
        }
    };
    reader.readAsText(file);
    event.target.value = ''; 
}

    function addBiz() { let n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞:"); if(n) { businesses.push({ name: n, data: { cash: 0, card: 0, profit: 0, stock: [], clients: [], vendors: {}, logs: [], stockLogs: [] } }); save(); renderBizList(); } }
    function deleteBiz(i) { if(confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª–∏–∞–ª —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏?")) { businesses.splice(i, 1); save(); renderBizList(); } }

    function selectBiz(i) {
        activeIdx = i; db = businesses[i].data;
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('active-title').innerText = businesses[i].name;
        render();
    }

    function render() {
        if(activeIdx === -1) return;
        document.getElementById('c-cash').innerText = Math.round(db.cash).toLocaleString();
        document.getElementById('c-card').innerText = Math.round(db.card).toLocaleString();
        document.getElementById('c-total').innerText = Math.round(db.cash + db.card).toLocaleString() + " —Å";
        document.getElementById('c-profit').innerText = Math.round(db.profit).toLocaleString();
        document.getElementById('c-debt-total').innerText = Math.round(db.clients.reduce((a,b)=>a+b.debt, 0)).toLocaleString();
        document.getElementById('c-stock-in').innerText = Math.round(db.stock.reduce((a,b)=>a+(b.pi*b.q),0)).toLocaleString();
        document.getElementById('c-stock-out').innerText = Math.round(db.stock.reduce((a,b)=>a+(b.po*b.q),0)).toLocaleString();
        
        document.getElementById('cash-logs').innerHTML = db.logs.map(l => `<div class="biz-card" style="padding:10px; margin-bottom:8px; font-size:11px"><span>${l.d}<br>${l.m}</span><b style="color:${l.s>=0? 'var(--s)':'var(--d)'}">${l.s}</b></div>`).reverse().join('');
        
        document.getElementById('stock-list').innerHTML = db.stock.map((i, idx) => `
            <div class="sq-card" onclick="openItemOpt(${idx})">
                <span class="badge" style="background:${i.m==='debt'?'var(--d)':'var(--s)'}">${i.m==='debt'?'–î–û–õ–ì':'OK'}</span>
                <b style="font-size:13px">${i.n}</b><small style="margin:5px 0">${i.q} —à—Ç</small><b style="color:var(--p)">${i.po} —Å</b>
            </div>`).join('');

        document.getElementById('client-list').innerHTML = db.clients.map((c, i) => `
            <div class="sq-card" onclick="openProfile(${i})">
                <b style="font-size:14px">${c.name}</b>
                <h2 style="color:${c.debt>0?'var(--d)':'var(--s)'}; margin:5px 0">${Math.round(c.debt)}</h2>
                <small style="font-size:9px; opacity:0.6">${c.phone || ''}</small>
            </div>`).join('');
        
        let vH = ''; for(let v in db.vendors) if(db.vendors[v]>0) vH += `<div class="biz-card" onclick="payVendorUI('${v}')"><b>${v}</b><b style="color:var(--d)">-${Math.round(db.vendors[v])}</b></div>`;
        document.getElementById('v-debt-list').innerHTML = vH || '<small>–î–æ–ª–≥–æ–≤ –Ω–µ—Ç</small>';
        document.getElementById('c-debt-list').innerHTML = db.clients.filter(c=>c.debt>0).map(c=>`<div class="biz-card"><b>${c.name}</b><b style="color:var(--d)">${Math.round(c.debt)}</b></div>`).join('');
        document.getElementById('sales-clients').innerHTML = db.clients.map((c,i)=>`<button class="btn btn-g" style="padding:12px" onclick="startPos(${i})">${c.name}</button>`).join('');
    }

    // --- –ö–õ–ò–ï–ù–¢–´ ---
    function addClient() {
        let n = document.getElementById('nc-n').value.trim();
        let p = document.getElementById('nc-p').value;
        if(n) {
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
            if(db.clients.find(c => c.name.toLowerCase() === n.toLowerCase())) return alert("–ö–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –µ—Å—Ç—å!");
            db.clients.push({ name: n, phone: p, debt: 0, pRatio: 0, history: [] });
            save(); closeMod(); render();
        } else alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");
    }

    function openProfile(i) {
        db.actC = i; let c = db.clients[i];
        document.getElementById('c-profile').style.display='flex';
        document.getElementById('cp-name').innerText = c.name;
        document.getElementById('cp-debt').innerText = Math.round(c.debt);
        document.getElementById('cp-call').href = "tel:" + c.phone;
        document.getElementById('cp-history').innerHTML = (c.history || []).map(h => `<div class="biz-card" style="font-size:11px; padding:10px"><span>${h.d}<br>${h.m}</span><b>${h.s}</b></div>`).reverse().join('');
    }

    function exportSingleBiz() {
    const currentBiz = businesses[activeIdx];
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentBiz));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    const fileName = `BACKUP_${currentBiz.name}_${dt().split(' ')[0]}.json`;
    downloadAnchorNode.setAttribute("download", fileName);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    
    alert("–ë–µ–∫–∞–ø —Ñ–∏–ª–∏–∞–ª–∞ " + currentBiz.name + " —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
}

    function doClientPay() {
        let s = Number(document.getElementById('cpp-s').value), m = document.getElementById('cpp-m').value, c = db.clients[db.actC];
        if(s > 0 && s <= (c.debt + 1)) {
            let profitPortion = (c.pRatio / c.debt) * s;
            db[m] += s;
            c.debt -= s;
            c.pRatio -= profitPortion;
            db.profit += profitPortion; 
            c.history.push({ d: dt(), m: `–û–ø–ª–∞—Ç–∞ –¥–æ–ª–≥–∞ (${m})`, s: "+"+s });
            db.logs.push({ d: dt(), m: `–î–æ–ª–≥ –æ—Ç ${c.name}`, s: s });
            save(); closeMod(); openProfile(db.actC); render();
        } else alert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞!");
    }

    // --- –°–ö–õ–ê–î –ò –ó–ê–ö–£–ü ---
    function doBuy() {
        let n=document.getElementById('b-n').value.trim(), 
            pi=Number(document.getElementById('b-pi').value), 
            po=Number(document.getElementById('b-po').value), 
            q=Number(document.getElementById('b-q').value), 
            v=document.getElementById('b-v').value||'–ü–æ—Å—Ç–∞–≤—â–∏–∫', 
            m=document.getElementById('b-m').value;

        if(!n || q<=0) return;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        if(m !== 'debt' && db[m] < pi*q) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");

        // –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏ –∏–ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–æ–ª–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É
        if(m !== 'debt') {
            db[m] -= pi*q;
            db.logs.push({ d: dt(), m: `–ó–∞–∫—É–ø: ${n}`, s: -(pi*q) });
        } else {
            db.vendors[v] = (db.vendors[v]||0) + (pi*q);
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ì–†–£–ü–ü–ò–†–û–í–ö–ê:
        // –ù–∞–ª –∏ –ö–∞—Ä—Ç–∞ —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞—é—Ç—Å—è –û–î–ù–ò–ú —Ç–∏–ø–æ–º (–æ–ø–ª–∞—á–µ–Ω–æ), –∞ –î–æ–ª–≥ - –î–†–£–ì–ò–ú.
        let existing = db.stock.find(item => 
            item.n.toLowerCase() === n.toLowerCase() && 
            item.pi === pi && 
            item.po === po && 
            ((m === 'debt' && item.m === 'debt') || (m !== 'debt' && item.m !== 'debt'))
        );

        if(existing) {
            existing.q += q;
        } else {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º m –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ –¥–ª—è –ª–æ–≥–∏–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –≤—ã—à–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
            db.stock.push({ n, pi, po, q, v, m, paySrc: m, isPaid: (m !== 'debt') }); 
        }

        db.stockLogs.push(`${dt()} | –ü—Ä–∏—Ö–æ–¥: ${n} (${q} —à—Ç)`);
        save(); closeMod(); render();
    }

    function openItemOpt(idx) { db.actI = idx; document.getElementById('mi-name').innerText = db.stock[idx].n; openMod('m-item-opt'); }

    function doItemAction(type) {
        let q = Number(document.getElementById('mi-q').value), i = db.stock[db.actI], r = document.getElementById('mi-r').value || '–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã';
        if(q <= 0 || q > i.q) return alert("–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!");
        if(type === 'return') {
            let sum = i.pi * q;
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –±—ã–ª –æ–ø–ª–∞—á–µ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫—É
            if(i.isPaid || i.m !== 'debt') {
                db[i.paySrc || 'cash'] += sum;
                db.logs.push({ d: dt(), m: `–í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞: ${i.n}`, s: sum });
            } else {
                db.vendors[i.v] = Math.max(0, db.vendors[i.v] - sum);
            }
        }
        db.stockLogs.push(`${dt()} | ${type.toUpperCase()}: ${i.n} (${q} —à—Ç). ${r}`);
        i.q -= q; if(i.q <= 0) db.stock.splice(db.actI, 1);
        save(); closeMod(); render();
    }

    // --- –ü–†–û–î–ê–ñ–ò (POS) ---
    function startPos(i) { db.actC = i; cart = []; document.getElementById('pos-select-c').style.display='none'; document.getElementById('pos-ui').style.display='block'; renderPosUI(); }
    function closePos() { document.getElementById('pos-select-c').style.display='block'; document.getElementById('pos-ui').style.display='none'; }
    function renderPosUI() {
        document.getElementById('pos-stock-list').innerHTML = db.stock.map((i, idx) => `<div class="biz-card" style="padding:10px" onclick="addToCart(${idx})"><b>${i.n}</b><br><small>${i.q}—à—Ç | ${i.po}—Å</small></div>`).join('');
        document.getElementById('pos-basket').innerHTML = cart.map((i, idx) => `<div style="display:flex; justify-content:space-between; margin-bottom:5px"><span>${i.n} x ${i.q}</span><b onclick="removeFromCart(${idx})">‚úï</b></div>`).join('');
        document.getElementById('pos-total').innerText = cart.reduce((a,b)=>a+(b.p*b.q),0) + " —Å";
    }
    function addToCart(idx) {
        let s = db.stock[idx], q = Number(prompt(s.n + " (–û—Å—Ç–∞—Ç–æ–∫: " + s.q + ")", 1));
        if(q > 0 && q <= s.q) {
            cart.push({ n: s.n, p: s.po, pi: s.pi, q, sIdx: idx });
            s.q -= q; renderPosUI();
        }
    }
    function removeFromCart(idx) { let c = cart[idx]; db.stock[c.sIdx].q += c.q; cart.splice(idx,1); renderPosUI(); }
    
    function finishSale(m) {
        let total = cart.reduce((a,b)=>a+(b.p*b.q),0);
        let profit = cart.reduce((a,b)=>a+((b.p-b.pi)*b.q),0);
        let cl = db.clients[db.actC];

        if(m === 'debt') {
            cl.debt += total;
            cl.pRatio = (cl.pRatio || 0) + profit;
        } else {
            db[m] += total;
            db.profit += profit;
            db.logs.push({ d: dt(), m: `–ü—Ä–æ–¥–∞–∂–∞ (${cl.name})`, s: total });
        }
        
        cart.forEach(c => cl.history.push({ d: dt(), m: `${c.n} (${c.q}—à—Ç)`, s: c.p*c.q }));
        db.stock = db.stock.filter(i => i.q > 0);
        save(); cart = []; closePos(); render();
    }

    // --- –ü–†–ê–í–ö–ò –ò –ü–ï–†–ï–í–û–î–´ ---
    function doAdj(plus) {
        let s=Number(document.getElementById('ad-s').value), m=document.getElementById('ad-m').value, n=document.getElementById('ad-n').value||'–ü—Ä–∞–≤–∫–∞';
        if(s>0) {
            if(!plus && db[m]<s) return alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
            db[m] = plus ? db[m]+s : db[m]-s;
            db.logs.push({ d: dt(), m: `–ü—Ä–∞–≤–∫–∞: ${n}`, s: plus?s:-s });
            save(); closeMod(); render();
        }
    }

    function doTransfer() {
        let s=Number(document.getElementById('tr-s').value), f=document.getElementById('tr-f').value, t=document.getElementById('tr-t').value;
        if(s>0 && db[f]>=s) {
            db[f]-=s; db[t]+=s;
            db.logs.push({ d: dt(), m: `–ü–µ—Ä–µ–≤–æ–¥: ${f} ‚Üí ${t}`, s: -s });
            save(); closeMod(); render();
        } else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
    }

    function payVendorUI(v) { db.actV = v; openMod('m-pay-vendor'); }
    function doPayVendor(m) {
        let s=Number(document.getElementById('pv-s').value);
        if(s>0 && s<=db.vendors[db.actV] && db[m]>=s) {
            db[m]-=s; db.vendors[db.actV]-=s;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –¥–æ–ª–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É –æ–ø–ª–∞—á–µ–Ω, –ø–æ–º–µ—á–∞–µ–º —Ç–æ–≤–∞—Ä –∫–∞–∫ "–≤—ã–∫—É–ø–ª–µ–Ω–Ω—ã–π" –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
            db.stock.forEach(item => { if(item.v === db.actV) { item.isPaid = true; item.paySrc = m; } });
            
            db.logs.push({ d: dt(), m: `–û–ø–ª–∞—Ç–∞ –ø–æ—Å—Ç. ${db.actV}`, s: -s });
            save(); closeMod(); render();
        } else alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã –∏–ª–∏ –±–∞–ª–∞–Ω—Å–∞!");
    }

    // --- –°–õ–£–ñ–ï–ë–ù–´–ï ---
    function askPin(n) { db.next=n; openMod('m-pin'); }
    function checkPin() { if(document.getElementById('pin-in').value==='1234') { let t=db.next; closeMod(); openMod(t); } else alert("PIN –ù–ï–í–ï–†–ï–ù!"); }
    
    function tab(p, el) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.getElementById('p-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function openMod(id) { document.getElementById('overlay').style.display='block'; document.getElementById(id).classList.add('active'); }
    function closeMod() { 
        document.getElementById('overlay').style.display='none'; 
        document.querySelectorAll('.modal').forEach(m => { m.classList.remove('active'); m.querySelectorAll('input').forEach(i => i.value = ""); });
    }

    function clearLogs(k) { if(confirm("–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?")) { db[k]=[]; save(); render(); } }
    function deleteClient() { if(confirm("–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?")) { db.clients.splice(db.actC, 1); save(); document.getElementById('c-profile').style.display='none'; render(); } }
    function doClientEdit() { db.clients[db.actC].debt = Number(document.getElementById('cpe-s').value); save(); closeMod(); openProfile(db.actC); render(); }

    function importData(inp) {
        const reader = new FileReader();
        reader.onload = (e) => { businesses.push(JSON.parse(e.target.result)); save(); location.reload(); };
        reader.readAsText(inp.files[0]);
    }

    async function exportPDF(type) {
        const doc = new jsPDF();
        
        // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º —à—Ä–∏—Ñ—Ç –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
        doc.addFont("https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf", "Roboto", "normal");
        doc.setFont("Roboto");

        const timestamp = dt();
        let title = "";
        let summaryData = [];
        let headers = [];
        let bodyData = [];

        if (type === 'cash') {
            title = `–û–¢–ß–ï–¢ –ü–û –ö–ê–°–°–ï - ${businesses[activeIdx].name}`;
            summaryData = [
                ["–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:", document.getElementById('c-total').innerText],
                ["–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:", document.getElementById('c-profit').innerText + " —Å"],
                ["–î–æ–ª–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞–º:", document.getElementById('c-debt-total').innerText + " —Å"],
                ["–°–∫–ª–∞–¥ (–∑–∞–∫—É–ø):", document.getElementById('c-stock-in').innerText + " —Å"],
                ["–°–∫–ª–∞–¥ (–ø—Ä–æ–¥–∞–∂–∞):", document.getElementById('c-stock-out').innerText + " —Å"]
            ];
            headers = [['–î–∞—Ç–∞', '–û–ø–∏—Å–∞–Ω–∏–µ', '–°—É–º–º–∞']];
            bodyData = db.logs.map(l => [l.d, l.s > 0 ? `(+) ${l.m}` : `(-) ${l.m}`, l.s.toLocaleString()]);
        } 
        
        else if (type === 'client') {
            const cl = db.clients[db.actC];
            title = `–ö–ê–†–¢–û–ß–ö–ê –ö–õ–ò–ï–ù–¢–ê: ${cl.name}`;
            summaryData = [
                ["–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:", cl.name],
                ["–¢–µ–ª–µ—Ñ–æ–Ω:", cl.phone || "–Ω–µ —É–∫–∞–∑–∞–Ω"],
                ["–¢–ï–ö–£–©–ò–ô –î–û–õ–ì:", cl.debt.toLocaleString() + " —Å"]
            ];
            headers = [['–î–∞—Ç–∞', '–ß—Ç–æ –∫—É–ø–∏–ª', '–°—É–º–º–∞']];
            bodyData = (cl.history || []).map(h => [
                h.d, 
                h.m, // –ó–¥–µ—Å—å —É–∂–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ "–û–ø–ª–∞—Ç–∞ –¥–æ–ª–≥–∞"
                h.s.toLocaleString()
            ]);
        }

        else if (type === 'stock') {
            title = `–û–¢–ß–ï–¢ –ü–û –°–ö–õ–ê–î–£ - ${businesses[activeIdx].name}`;
            summaryData = [
                ["–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π:", db.stock.length],
                ["–°—É–º–º–∞ –∑–∞–∫—É–ø–∞:", document.getElementById('c-stock-in').innerText],
                ["–û–∂–∏–¥–∞–µ–º–∞—è –≤—ã—Ä—É—á–∫–∞:", document.getElementById('c-stock-out').innerText]
            ];
            headers = [['–¢–æ–≤–∞—Ä', '–ö–æ–ª-–≤–æ', '–ó–∞–∫—É–ø (–µ–¥)', '–ü—Ä–æ–¥–∞–∂–∞ (–µ–¥)', '–°—Ç–∞—Ç—É—Å']];
            bodyData = db.stock.map(i => [
                i.n, 
                i.q + " —à—Ç", 
                i.pi.toLocaleString(), 
                i.po.toLocaleString(), 
                i.m === 'debt' ? "–í –î–û–õ–ì" : "–û–ü–õ–ê–ß–ï–ù–û"
            ]);
        }

        // –†–ò–°–£–ï–ú PDF
        doc.setFontSize(16);
        doc.text(title, 14, 15);
        
        doc.setFontSize(10);
        doc.text(`–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${timestamp}`, 14, 22);

        // 1. –†–∏—Å—É–µ–º —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (–ò–¢–û–ì–ò)
        doc.autoTable({
            startY: 30,
            body: summaryData,
            theme: 'grid',
            styles: { font: "Roboto", fontSize: 11, cellPadding: 3 },
            columnStyles: { 0: { fontStyle: 'bold', width: 60 } }
        });

        // 2. –†–∏—Å—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
        doc.setFontSize(12);
        doc.text(type === 'stock' ? "–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤:" : "–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π:", 14, doc.lastAutoTable.finalY + 10);

        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 15,
            head: headers,
            body: bodyData,
            theme: 'striped',
            styles: { font: "Roboto", fontSize: 9 },
            headStyles: { fillColor: [59, 130, 246] }
        });

        doc.save(`${type}_report_${timestamp}.pdf`);
    }

    renderBizList();
</script>
</body>
</html>
